<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla Jur√≠dica - Familia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #3498db;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --light-text: #ffffff;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: var(--light-text); border-radius: var(--border-radius);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text); padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-content { padding: 30px; }
        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-bottom: 40px;
        }
        .card {
            background: var(--light-text); border-radius: var(--border-radius); padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
        .card h3 {
            color: var(--dark-text); margin-bottom: 20px; font-size: 1.3em;
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--light-bg); padding-bottom: 10px;
        }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .today-reviews { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: var(--light-text); }
        .overdue-reviews { background: linear-gradient(135deg, #e74c3c, #c0392b); color: var(--light-text); }
        .pending-reviews { background: linear-gradient(135deg, #feca57, #ff9f43); color: var(--light-text); }
        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text); border: none; padding: 12px 24px; border-radius: 8px;
            cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 5px;
            text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(41, 128, 185, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #27ae60); }
        .btn-info { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark-text); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }
        .reviews-list { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .review-item {
            background: #f8f9fa; border-left: 4px solid var(--secondary-color); padding: 15px;
            margin-bottom: 10px; border-radius: 0 8px 8px 0; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px;
        }
        .review-item-content { flex-grow: 1; cursor: pointer; }
        .review-item.completed .review-item-content { text-decoration: line-through; opacity: 0.6; }
        .review-item.completed { border-left-color: var(--success-color); background-color: #f2fdf5; }
        .review-item:hover { background: #e8f2ff; transform: translateX(5px); }
        .review-item.today { border-left-color: #ff7e5f; background: #fff5f5; }
        .review-item.overdue { border-left-color: var(--danger-color); background: #fef9e7; }
        .review-date { font-weight: 600; color: var(--dark-text); font-size: 1.1em; }
        .review-client { font-size: 1em; color: var(--primary-color); margin: 5px 0; font-weight: 500; }
        .review-obs { font-size: 0.9em; color: #666; font-style: italic; }
        .complete-btn {
            background: #e0e0e0; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            font-size: 16px; flex-shrink: 0; line-height: 30px;
        }
        .complete-btn:hover { background: #c0c0c0; }
        .review-item.completed .complete-btn { background: var(--success-color); color: var(--light-text); }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--light-text); border-radius: var(--border-radius); padding: 30px; width: 95%;
            max-width: 900px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .client-info { background: var(--light-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .client-info h4 { color: var(--dark-text); margin-bottom: 15px; font-size: 1.2em; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .info-grid.full-width > .info-item { grid-column: 1 / -1; }
        .info-item { background: var(--light-text); padding: 12px; border-radius: 5px; border-left: 3px solid var(--primary-color); }
        .info-label { font-size: 0.8em; color: #666; text-transform: uppercase; font-weight: 600; }
        .info-value { font-size: 1em; color: var(--dark-text); margin-top: 2px; font-weight: 500; }
        .editable-field { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.3s ease; min-height: 20px; }
        .editable-field:hover { background-color: #e8f4fd; color: #2980b9; }
        .observations-history { margin-top: 20px; }
        .obs-item { background: var(--light-text); border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .obs-date { font-size: 0.9em; color: var(--primary-color); font-weight: 600; margin-bottom: 5px; }
        .obs-text { color: var(--dark-text); }
        .obs-revision-date { font-size: 0.8em; color: var(--danger-color); margin-top: 5px; font-weight: 500; }
        .close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .data-status {
            background: #d4edda; border: 1px solid #c3e6cb; color: #155724;
            padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;
        }
        .filter-bar {
            background: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>‚öñÔ∏è Planilla Jur√≠dica - Familia</h1>
            <p>Gesti√≥n de Casos y Expedientes</p>
        </header>

        <main class="main-content">
            <div id="dataStatus" class="data-status">Cargando datos...</div>
            <div id="driveStatus" class="data-status" style="display: none;"></div>

            <section class="dashboard">
                <div class="card today-reviews">
                    <h3><i class="icon"></i>Revisiones de Hoy</h3>
                    <div class="reviews-list" id="todayReviews"></div>
                </div>
                <div class="card overdue-reviews">
                    <h3><i class="icon"></i>Revisiones Vencidas</h3>
                    <div class="reviews-list" id="overdueReviews"></div>
                </div>
                <div class="card pending-reviews">
                    <h3><i class="icon"></i>Pr√≥ximas Revisiones</h3>
                    <div class="reviews-list" id="upcomingReviews"></div>
                </div>
            </section>

            <section style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-success" onclick="showNewClientModal()">‚ûï Agregar Caso</button>
                <button class="btn" onclick="showClientSelectorModal()">üëÅÔ∏è Ver/Editar Caso</button>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-info" onclick="exportData()">üíæ Exportar JSON</button>
                <button class="btn btn-warning" onclick="importData()">üì• Importar Datos</button>
            </section>
            
            <section style="text-align: center; margin-bottom: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button id="connectDriveBtn" class="btn">üîó Conectar a Drive</button>
                <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
                <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
            </section>

            <section class="filter-bar">
                <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Buscar por actor, demandado, exp, etc." onkeyup="renderAllClientsList()"></div>
                <div class="form-group"><label>Filtrar por Estado</label><select id="estadoFilter" onchange="renderAllClientsList()"><option value="">Todos los estados</option><option value="INICIADO">Iniciado</option><option value="EN LETRA">En Letra</option><option value="FINALIZADO">Finalizado</option><option value="MEDIACION">Mediaci√≥n</option><option value="APELADO">Apelado</option></select></div>
            </section>

            <section class="card">
                <h3>üìã Todos los Casos (Ordenados por fecha de revisi√≥n)</h3>
                <div class="reviews-list" id="allClients" style="max-height: 600px;"></div>
            </section>
        </main>
    </div>

    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">

    <div id="newClientModal" class="modal"><div class="modal-content"></div></div>
    <div id="clientSelectorModal" class="modal"><div class="modal-content"></div></div>
    <div id="clientInfoModal" class="modal"><div class="modal-content"></div></div>
    
    <script>
        const initialData = [];
        let clientsData = [];
        let editingClientId = null, editingField = null;

        function saveData() {
            localStorage.setItem('planilla_juridica_data', JSON.stringify(clientsData));
            updateDataStatus('‚úÖ Datos guardados localmente');
        }

        // --- FUNCI√ìN DE CARGA CON MECANISMO DE AUTO-REPARACI√ìN ---
        function loadData() {
            const savedData = localStorage.getItem('planilla_juridica_data');
            let data = savedData ? JSON.parse(savedData) : [];

            // Usamos un Map para garantizar expedientes √∫nicos.
            const uniqueClients = new Map();
            data.forEach(client => {
                // La clave ser√° el N¬∞ de Expediente si existe y no est√° vac√≠o, sino el ID del cliente.
                const key = (client.expediente && String(client.expediente).trim() !== '') ? String(client.expediente).trim() : client.id;
                if (!uniqueClients.has(key)) {
                    uniqueClients.set(key, client);
                }
            });
            const deduplicatedData = Array.from(uniqueClients.values());

            let statusMessage = savedData ? '‚úÖ Datos cargados desde almacenamiento local' : 'üìã Planilla lista. Agregue su primer caso.';
            let needsSave = false;
            
            // Si se eliminaron duplicados, se notifica y se prepara para guardar.
            if (deduplicatedData.length < data.length) {
                console.warn(`Se eliminaron ${data.length - deduplicatedData.length} expedientes duplicados.`);
                statusMessage = `‚ö†Ô∏è Se repararon ${data.length - deduplicatedData.length} casos duplicados.`;
                needsSave = true;
            }

            clientsData = sanitizeData(deduplicatedData);
            
            // Si el archivo fue reparado, se guarda la versi√≥n limpia inmediatamente.
            if (needsSave) {
                saveData();
            }
            
            updateDataStatus(statusMessage, needsSave);
        }

        function sanitizeData(data) {
            (data || []).forEach(c => {
                c.id = c.id || generateId(c);
                c.observaciones = Array.isArray(c.observaciones) ? c.observaciones : [];
                c.observaciones.forEach(obs => {
                    obs.id = obs.id || generateId({});
                    obs.completed = typeof obs.completed === 'boolean' ? obs.completed : false;
                });
                updateClientNextRevision(c);
            });
            return data;
        }

        function updateDataStatus(message, isWarning = false) {
            const el = document.getElementById('dataStatus');
            el.textContent = message;
            el.style.background = isWarning ? '#fff3cd' : '#d4edda';
            el.style.color = isWarning ? '#664d03' : '#155724';
        }
        
        function getTodayYMD() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
        const todayYMD = getTodayYMD();
        function formatDate(dateString) { if (!dateString) return 'No definida'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
        function isToday(dateString) { return dateString && dateString === todayYMD; }
        function isPastDue(dateString) { return dateString && dateString < todayYMD; }
        function getDaysDifference(dateString) { if (!dateString) return 999; const today = new Date(todayYMD); const target = new Date(dateString); return Math.ceil((target - today) / (1000 * 60 * 60 * 24)); }
        
        function generateId(item) { return `CLI_${(item.actor || 'A').slice(0,3).toUpperCase()}_${Date.now()}`; }
        function getDisplayName(c) { return `${c.actor} vs ${c.demandado} - Exp: ${c.expediente || 'S/N'}`; }

        function updateClientNextRevision(client) {
            const futureObs = (client.observaciones || [])
                .filter(obs => !obs.completed && obs.proximaRevision)
                .sort((a, b) => a.proximaRevision.localeCompare(b.proximaRevision));
            
            if (futureObs.length > 0) {
                client.fechaRevision = futureObs[0].proximaRevision;
                client.observacion = futureObs[0].texto;
            } else {
                client.fechaRevision = '';
                client.observacion = 'No hay tareas pendientes';
            }
        }

        function toggleCompleted(event, clientId, obsId) {
            event.stopPropagation();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const obs = client.observaciones.find(o => o.id === obsId);
            if (!obs) return;
            obs.completed = !obs.completed;
            updateClientNextRevision(client);
            saveData();
            renderAll();
        }

        function renderAll() {
            clientsData.forEach(updateClientNextRevision);
            renderDashboardLists();
            renderAllClientsList();
        }

        function renderDashboardLists() {
            const allTasks = clientsData.flatMap(client => (client.observaciones || []).map(obs => ({...obs, client})));
            const todayTasks = allTasks.filter(task => !task.completed && isToday(task.proximaRevision));
            const overdueTasks = allTasks.filter(task => !task.completed && isPastDue(task.proximaRevision)).sort((a,b) => a.proximaRevision.localeCompare(b.proximaRevision));
            const upcomingTasks = allTasks.filter(task => !task.completed && getDaysDifference(task.proximaRevision) > 0).sort((a,b) => a.proximaRevision.localeCompare(b.proximaRevision));

            renderReviewList('todayReviews', todayTasks, 'No hay revisiones para hoy', 'today');
            renderReviewList('overdueReviews', overdueTasks, 'No hay revisiones vencidas', 'overdue');
            renderReviewList('upcomingReviews', upcomingTasks, 'No hay pr√≥ximas revisiones', 'upcoming');
        }

        function renderReviewList(containerId, tasks, emptyMsg, type) {
            const container = document.getElementById(containerId);
            const listColor = (type === 'today' || type === 'overdue' || type === 'pending-reviews') ? 'var(--light-text)' : 'rgba(0,0,0,0.6)';
            container.innerHTML = tasks.length === 0 ? `<p style="color: ${listColor}; text-align: center;">${emptyMsg}</p>` : tasks.map(task => {
                let dateInfo = '';
                if (type === 'today') dateInfo = 'HOY';
                else if (type === 'overdue') dateInfo = `VENCIDA - ${formatDate(task.proximaRevision)}`;
                else dateInfo = `En ${getDaysDifference(task.proximaRevision)} d√≠as - ${formatDate(task.proximaRevision)}`;
                
                return `<div class="review-item"><button class="complete-btn" onclick="toggleCompleted(event, '${task.client.id}', '${task.id}')">‚úî</button><div class="review-item-content" onclick="showClientModal('${task.client.id}')"><div class="review-date">${dateInfo}</div><div class="review-client">${task.client.actor} vs ${task.client.demandado}</div><div class="review-obs">${task.texto}</div></div></div>`;
            }).join('');
        }
        
        function renderAllClientsList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            const filteredData = clientsData.filter(c => {
                const searchString = `${c.actor} ${c.demandado} ${c.expediente} ${c.juzgado} ${c.estado}`.toLowerCase();
                const matchesSearch = !searchTerm || searchString.includes(searchTerm);
                const matchesEstado = !estadoFilter || c.estado === estadoFilter;
                return matchesSearch && matchesEstado;
            }).sort((a, b) => (a.fechaRevision || '9999').localeCompare(b.fechaRevision || '9999'));

            document.getElementById('allClients').innerHTML = filteredData.length === 0 ? '<p>No se encontraron casos.</p>' : filteredData.map(c => {
                const hasPendingTask = (c.observaciones || []).some(obs => !obs.completed && obs.proximaRevision);
                const classes = `review-item ${!hasPendingTask ? 'completed' : ''} ${isToday(c.fechaRevision) ? 'today' : ''} ${isPastDue(c.fechaRevision) ? 'overdue' : ''}`;
                return `<div class="${classes}" onclick="showClientModal('${c.id}')"><div class="review-item-content"><div class="review-date">Pr√≥x. Revisi√≥n: ${formatDate(c.fechaRevision)}</div><div class="review-client">${getDisplayName(c)}</div><div class="review-obs">√ölt. Tarea: ${c.observacion}</div></div></div>`;
            }).join('');
        }

        function showNewClientModal() { document.getElementById('newClientModal').classList.add('active'); }
        function showClientSelectorModal() {
            const selector = document.getElementById('clientSelector');
            selector.innerHTML = '<option value="">-- Seleccionar Caso --</option>' + [...clientsData].sort((a,b) => a.actor.localeCompare(b.actor)).map(c => `<option value="${c.id}">${getDisplayName(c)}</option>`).join('');
            document.getElementById('clientSelectorModal').classList.add('active');
        }
        function loadClientInfo() { const clientId = document.getElementById('clientSelector').value; if (clientId) { closeModal('clientSelectorModal'); showClientModal(clientId); } }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); editingClientId = null; editingField = null; }

        function showClientModal(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            updateClientNextRevision(client);
            const content = `
                <span class="close" onclick="closeModal('clientInfoModal')">&times;</span><h2>‚öñÔ∏è ${getDisplayName(client)}</h2>
                <div class="client-info">
                    <h4>üìã Informaci√≥n del Caso</h4>
                    <div class="info-grid">
                        ${Object.entries({actor: 'Actor', demandado: 'Demandado', expediente: 'N¬∞ Expediente', juzgado: 'Juzgado', estado: 'Estado'}).map(([key, label]) => `
                        <div class="info-item"><div class="info-label">${label}</div><div class="editable-field" id="field-${key}" onclick="editField('${client.id}', '${key}', '${String(client[key] || '').replace(/'/g, '&#39;')}')"><div class="info-value">${client[key] || 'S/D'}</div></div></div>`).join('')}
                        <div class="info-item"><div class="info-label">Pr√≥xima Tarea</div><div class="info-value" style="color: var(--danger-color); font-weight: bold;">${formatDate(client.fechaRevision)}</div></div>
                    </div>
                </div>
                <div class="observations-history">
                    <h4>üìù Historial de Tareas</h4>
                    <div id="obs-list-${client.id}" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px;">
                        ${renderObsList(client)}
                    </div>
                </div>
                <form class="form-group" onsubmit="addObservation(event, '${client.id}')" style="background: var(--light-bg); padding: 20px; border-radius: 8px;"><h4>‚ûï Agregar Tarea</h4><div class="form-group"><label>Texto</label><textarea id="newObsText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div><button type="submit" class="btn btn-success">üíæ Guardar Tarea</button></form>
                <div class="action-buttons"><button class="btn btn-danger" onclick="deleteClient('${client.id}')">üóëÔ∏è Eliminar Caso</button></div>`;
            document.getElementById('clientInfoModal').querySelector('.modal-content').innerHTML = content;
            document.getElementById('clientInfoModal').classList.add('active');
        }

        function renderObsList(client) {
            return (client.observaciones || []).length === 0 ? '<p>No hay tareas registradas.</p>' : [...client.observaciones].sort((a, b) => (b.proximaRevision || '').localeCompare(a.proximaRevision || '')).map(obs => {
                const isNextTask = obs.proximaRevision === client.fechaRevision && !obs.completed;
                return `<div id="obs-item-${obs.id}" class="obs-item ${obs.completed ? 'completed' : ''}" style="${isNextTask ? 'border-left: 5px solid var(--danger-color);' : ''}">
                    <div class="obs-date">Creada: ${formatDate(obs.fecha)}</div>
                    <div class="obs-text">${obs.texto}</div>
                    <div class="obs-revision-date">Revisar el: ${formatDate(obs.proximaRevision)}</div>
                    <button class="btn btn-sm" onclick="editObs('${client.id}', '${obs.id}')">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteObs('${client.id}', '${obs.id}')">Eliminar</button>
                </div>`;
            }).join('');
        }

        function editObs(clientId, obsId) {
            const obs = clientsData.find(c => c.id === clientId).observaciones.find(o => o.id === obsId);
            const itemElement = document.getElementById(`obs-item-${obsId}`);
            itemElement.innerHTML = `
                <div class="form-group"><label>Texto</label><textarea id="edit-obs-text-${obsId}" rows="2">${obs.texto}</textarea></div>
                <div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${obsId}" value="${obs.proximaRevision}"></div>
                <button class="btn btn-success btn-sm" onclick="saveObs('${clientId}', '${obsId}')">Guardar</button>
                <button class="btn btn-sm" onclick="showClientModal('${clientId}')">Cancelar</button>
            `;
        }

        function saveObs(clientId, obsId) {
            const client = clientsData.find(c => c.id === clientId);
            const obs = client.observaciones.find(o => o.id === obsId);
            obs.texto = document.getElementById(`edit-obs-text-${obsId}`).value;
            obs.proximaRevision = document.getElementById(`edit-obs-revision-${obsId}`).value;
            updateClientNextRevision(client);
            saveData();
            renderAll();
            showClientModal(clientId);
        }
        
        function deleteObs(clientId, obsId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) return;
            const client = clientsData.find(c => c.id === clientId);
            client.observaciones = client.observaciones.filter(o => o.id !== obsId);
            updateClientNextRevision(client);
            saveData();
            renderAll();
            showClientModal(clientId);
        }

        function editField(clientId, fieldName, currentValue) {
            editingClientId = clientId; editingField = fieldName;
            const fieldElement = document.getElementById(`field-${fieldName}`);
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            fieldElement.innerHTML = ''; fieldElement.appendChild(input); input.focus();
            input.addEventListener('blur', saveField);
            input.addEventListener('keypress', e => { if (e.key === 'Enter') saveField(); });
        }
        function saveField() {
            if (!editingClientId || !editingField) return;
            const client = clientsData.find(c => c.id === editingClientId);
            const input = document.getElementById(`field-${editingField}`).querySelector('input');
            if (client && input) { client[editingField] = input.value; saveData(); renderAll(); showClientModal(editingClientId); }
            editingClientId = null; editingField = null;
        }
        function deleteClient(id) { if (confirm('¬øEst√° seguro de que quiere eliminar este caso y todo su historial? Esta acci√≥n no se puede deshacer.')) { clientsData = clientsData.filter(c => c.id !== id); saveData(); renderAll(); closeModal('clientInfoModal'); } }
        function addObservation(event, clientId) {
            event.preventDefault();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            client.observaciones.push({ id: generateId({}), fecha: getTodayYMD(), texto: document.getElementById('newObsText').value, proximaRevision: document.getElementById('newRevisionDate').value, completed: false });
            updateClientNextRevision(client);
            saveData(); renderAll(); showClientModal(clientId);
        }

        function exportToExcel() {
            const excelData = clientsData.map(c => {
                const allObs = (c.observaciones || []).map(obs => `[${formatDate(obs.fecha)}] (Revisar: ${formatDate(obs.proximaRevision)}): ${obs.texto}`).join(' \n ');
                return { 'Actor': c.actor, 'Demandado': c.demandado, 'Expediente': c.expediente, 'Juzgado': c.juzgado, 'Estado': c.estado, 'Pr√≥xima Revisi√≥n': formatDate(c.fechaRevision), '√öltima Tarea': c.observacion, 'Historial Completo': allObs };
            });
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Casos Familia');
            XLSX.writeFile(workbook, `Casos_Familia_${getTodayYMD()}.xlsx`);
        }
        function exportData() { const dataStr = JSON.stringify(clientsData, null, 2); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'})); link.download = `casos_familia_${getTodayYMD()}.json`; link.click(); }
        function importData() { document.getElementById('importInput').click(); }
        function handleImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported) && confirm(`¬øImportar ${imported.length} casos? Esto sobreescribir√° los datos actuales.`)) { clientsData = imported; saveData(); renderAll(); } } catch (err) { alert('Error al importar el archivo. Verifique que sea un JSON v√°lido.'); } };
            reader.readAsText(file); event.target.value = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newClientModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('newClientModal')">&times;</span><h2>‚ûï Agregar Nuevo Caso</h2><form id="newClientForm"><div class="info-grid"><div class="form-group"><label>Actor *</label><input type="text" id="newActor" required></div><div class="form-group"><label>Demandado *</label><input type="text" id="newDemandado" required></div><div class="form-group"><label>N¬∞ Expediente</label><input type="text" id="newExpediente"></div><div class="form-group"><label>Juzgado</label><input type="text" id="newJuzgado"></div><div class="form-group"><label>Estado *</label><select id="newEstado" required><option value="INICIADO">Iniciado</option><option value="EN LETRA">En Letra</option><option value="FINALIZADO">Finalizado</option><option value="MEDIACION">Mediaci√≥n</option><option value="APELADO">Apelado</option></select></div></div><div class="form-group" style="margin-top:20px;"><label>Tarea Inicial (Opcional)</label><textarea id="newObservacion" rows="3"></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n para Tarea Inicial</label><input type="date" id="newFechaRevision"></div><div style="text-align:center;"><button type="submit" class="btn btn-success">üíæ Guardar Caso</button></div></form>`;
            document.getElementById('clientSelectorModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('clientSelectorModal')">&times;</span><h2>üëÅÔ∏è Seleccionar Caso</h2><div class="form-group"><select id="clientSelector" onchange="loadClientInfo()"></select></div>`;
            
            document.getElementById('newClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const expedienteInput = document.getElementById('newExpediente');
                const expedienteValue = expedienteInput.value.trim();

                if (expedienteValue && clientsData.some(client => client.expediente && client.expediente.trim() === expedienteValue)) {
                    alert(`Error: Ya existe un caso con el n√∫mero de expediente "${expedienteValue}".\nPor favor, verifique los datos.`);
                    return;
                }

                const newClient = {
                    id: generateId({}),
                    actor: document.getElementById('newActor').value.toUpperCase(),
                    demandado: document.getElementById('newDemandado').value.toUpperCase(),
                    expediente: expedienteValue,
                    juzgado: document.getElementById('newJuzgado').value.toUpperCase(),
                    estado: document.getElementById('newEstado').value,
                    observaciones: []
                };
                const obsText = document.getElementById('newObservacion').value;
                const revDate = document.getElementById('newFechaRevision').value;
                if (obsText && revDate) {
                    newClient.observaciones.push({
                        id: generateId({}),
                        fecha: getTodayYMD(),
                        texto: obsText,
                        proximaRevision: revDate,
                        completed: false
                    });
                }
                updateClientNextRevision(newClient);
                clientsData.push(newClient);
                saveData();
                renderAll();
                closeModal('newClientModal');
                e.target.reset();
            });

            loadData();
            renderAll();
        });
        window.addEventListener('click', e => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DATA_FILE_NAME = 'datos_planilla_juridica.json';

        let tokenClient, gapiInited = false, gisInited = false, dataFileId = null;
        const driveStatusEl = document.getElementById('driveStatus'), connectDriveBtn = document.getElementById('connectDriveBtn'), saveToDriveBtn = document.getElementById('saveToDriveBtn'), loadFromDriveBtn = document.getElementById('loadFromDriveBtn');

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; maybeEnableButtons(); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
        function maybeEnableButtons() { if (gapiInited && gisInited) connectDriveBtn.onclick = handleAuthClick; }
        function updateDriveStatus(message, isConnected = false) { driveStatusEl.style.display = 'block'; driveStatusEl.textContent = message; driveStatusEl.style.background = isConnected ? '#d1e7dd' : '#fff3cd'; driveStatusEl.style.color = isConnected ? '#0f5132' : '#664d03'; }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw (resp);
                updateDriveStatus('‚úÖ Conectado a Google Drive', true);
                connectDriveBtn.style.display = 'none'; saveToDriveBtn.style.display = 'inline-block'; loadFromDriveBtn.style.display = 'inline-block';
                saveToDriveBtn.onclick = saveDataToDrive; loadFromDriveBtn.onclick = loadDataFromDrive;
                await findDataFile();
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); else tokenClient.requestAccessToken({prompt: ''});
        }
        async function findDataFile() {
            updateDriveStatus('Buscando archivo de datos en Drive...', false);
            try {
                const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
                if (response.result.files.length > 0) { dataFileId = response.result.files[0].id; updateDriveStatus('‚úÖ Archivo de datos encontrado en Drive.', true); }
                else { updateDriveStatus('‚ö†Ô∏è Archivo no encontrado. Se crear√° uno nuevo al guardar.', false); dataFileId = null; }
            } catch (err) { console.error(err); alert('Error al buscar el archivo de datos en Drive.'); }
        }
        async function saveDataToDrive() {
            if (!confirm('¬øGuardar los datos actuales en Google Drive? Esto sobreescribir√° la versi√≥n anterior en la nube.')) return;
            updateDriveStatus('Guardando datos en Drive...', false);
            const content = JSON.stringify(clientsData, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify({ name: DATA_FILE_NAME })], { type: 'application/json' }));
            form.append('file', blob);

            let url = 'https://www.googleapis.com/upload/drive/v3/files';
            let method = 'POST';
            if (dataFileId) {
                url += `/${dataFileId}`;
                method = 'PATCH';
            }
            url += '?uploadType=multipart';

            try {
                const response = await fetch(url, { method, headers: new Headers({ 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }), body: form });
                const result = await response.json();
                if (result.error) throw new Error(result.error.message);
                dataFileId = result.id;
                updateDriveStatus('‚úÖ ¬°Datos guardados en Drive con √©xito!', true);
            } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al guardar en Drive.', false); alert('Error al guardar en Drive: ' + err.message); }
        }
        async function loadDataFromDrive() {
            if (!dataFileId) return alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno.");
            if (!confirm("¬øSeguro? Se reemplazar√°n los datos locales con los de Drive.")) return;
            updateDriveStatus('Cargando datos desde Drive...', false);
            try {
                const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
                const importedData = JSON.parse(response.body);
                if (!Array.isArray(importedData)) throw new Error('Formato no v√°lido.');
                clientsData = importedData;
                saveData(); // Guardar localmente los datos importados de Drive
                loadData(); // Recargar los datos para aplicar la limpieza de duplicados si es necesario
                renderAll();
                updateDriveStatus('‚úÖ Datos cargados desde Drive con √©xito.', true);
            } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al cargar desde Drive.', false); alert('Error al cargar desde Drive: ' + err.message); }
        }
    </script>
</body>
</html>
