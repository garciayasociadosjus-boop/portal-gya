<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla Jur√≠dica - Familia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #3498db;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --light-text: #ffffff;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: var(--light-text); border-radius: var(--border-radius);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #020c24 0%, #081e4b 100%);
            color: var(--light-text); padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-content { padding: 30px; }
        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-bottom: 40px;
        }
        .card {
            background: var(--light-text); border-radius: var(--border-radius); padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
        .card h3 {
            color: var(--dark-text); margin-bottom: 20px; font-size: 1.3em;
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--light-bg); padding-bottom: 10px;
        }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .today-reviews { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: var(--light-text); }
        .overdue-reviews { background: linear-gradient(135deg, #e74c3c, #c0392b); color: var(--light-text); }
        .pending-reviews { background: linear-gradient(135deg, #feca57, #ff9f43); color: var(--light-text); }
        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text); border: none; padding: 12px 24px; border-radius: 8px;
            cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 5px;
            text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(41, 128, 185, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #27ae60); }
        .btn-info { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark-text); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }
        .reviews-list { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .review-item {
            background: #f8f9fa; border-left: 4px solid var(--secondary-color); padding: 15px;
            margin-bottom: 10px; border-radius: 0 8px 8px 0; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px;
        }
        .review-item-content { flex-grow: 1; cursor: pointer; }
        .review-item.completed .review-item-content { text-decoration: line-through; opacity: 0.6; }
        .review-item.completed { border-left-color: var(--success-color); background-color: #f2fdf5; }
        .review-item:hover { background: #e8f2ff; transform: translateX(5px); }
        .review-item.today { border-left-color: #ff7e5f; background: #fff5f5; }
        .review-item.overdue { border-left-color: var(--danger-color); background: #fef9e7; }
        .review-date { font-weight: 600; color: var(--dark-text); font-size: 1.1em; }
        .review-client { font-size: 1em; color: var(--primary-color); margin: 5px 0; font-weight: 500; }
        .review-obs { font-size: 0.9em; color: #666; font-style: italic; }
        .complete-btn {
            background: #e0e0e0; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            font-size: 16px; flex-shrink: 0; line-height: 30px;
        }
        .complete-btn:hover { background: #c0c0c0; }
        .review-item.completed .complete-btn { background: var(--success-color); color: var(--light-text); }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--light-text); border-radius: var(--border-radius); padding: 30px; width: 95%;
            max-width: 900px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #vencimientoAlertModal .modal-content {
            border-top: 10px solid var(--danger-color);
        }
        #vencimientoAlertModal h2 {
            color: var(--danger-color);
            text-align: center;
            margin-bottom: 20px;
        }
        .client-info { background: var(--light-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .client-info h4 { color: var(--dark-text); margin-bottom: 15px; font-size: 1.2em; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .info-grid.full-width > .info-item { grid-column: 1 / -1; }
        .info-item { background: var(--light-text); padding: 12px; border-radius: 5px; border-left: 3px solid var(--primary-color); }
        .info-label { font-size: 0.8em; color: #666; text-transform: uppercase; font-weight: 600; }
        .info-value { font-size: 1em; color: var(--dark-text); margin-top: 2px; font-weight: 500; }
        .editable-field { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.3s ease; min-height: 20px; }
        .editable-field:hover { background-color: #e8f4fd; color: #2980b9; }
        .history-section { margin-top: 20px; }
        .history-item { background: var(--light-text); border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .history-item-audience { border-left: 5px solid #8e44ad; }
        .history-item-task { border-left: 5px solid var(--secondary-color); }
        .history-item-vencimiento { border-left: 5px solid #ff6347; }
        .history-date { font-size: 0.9em; color: var(--primary-color); font-weight: 600; margin-bottom: 5px; display: flex; align-items: center;}
        .history-text { color: var(--dark-text); }
        .history-tag { font-size: 0.8em; color: #fff; padding: 2px 8px; border-radius: 10px; margin-top: 5px; font-weight: 500; display: inline-block; }
        .tag-audience { background-color: #8e44ad; }
        .tag-task { background-color: var(--secondary-color); }
        .tag-vencimiento { background-color: #ff6347; }
        .close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .data-status {
            background: #d4edda; border: 1px solid #c3e6cb; color: #155724;
            padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;
        }
        .filter-bar {
            background: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        .document-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .document-list li { background: #f1f3f5; padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .document-list a { color: #3498db; text-decoration: none; font-weight: 500; word-break: break-all; }
        .document-list a:hover { text-decoration: underline; }
        .document-list .btn-sm { flex-shrink: 0; margin-left: 10px; }
        .document-list .spinner { display: block; margin: 20px auto; width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .print-area h2, .print-area h3, .print-area h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
            .print-area .info-grid { display: block; }
            .print-area .info-item { border: 1px solid #eee; padding: 8px; margin-bottom: 5px; page-break-inside: avoid; }
            .print-area .history-item { border: 1px solid #eee; padding: 8px; margin-bottom: 5px; page-break-inside: avoid; }
            .print-area .btn, .print-area .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>‚öñÔ∏è Planilla Jur√≠dica - Familia</h1>
            <p>Gesti√≥n de Casos y Expedientes</p>
        </header>

        <main class="main-content">
            <div id="dataStatus" class="data-status">Cargando datos...</div>
            <div id="driveStatus" class="data-status" style="display: none;"></div>

            <section class="dashboard">
                <div class="card today-reviews">
                    <h3><i class="icon"></i>Revisiones de Hoy</h3>
                    <div class="reviews-list" id="todayReviews"></div>
                </div>
                <div class="card overdue-reviews">
                    <h3><i class="icon"></i>Revisiones Vencidas</h3>
                    <div class="reviews-list" id="overdueReviews"></div>
                </div>
                <div class="card pending-reviews">
                    <h3><i class="icon"></i>Pr√≥ximas Revisiones</h3>
                    <div class="reviews-list" id="upcomingReviews"></div>
                </div>
            </section>

            <section style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-success" onclick="showNewClientModal()">‚ûï Agregar Caso</button>
                <button class="btn" onclick="showClientSelectorModal()">üëÅÔ∏è Ver/Editar Caso</button>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-info" onclick="exportData()">üíæ Exportar JSON</button>
                <button class="btn btn-warning" onclick="importData()">üì• Importar Datos</button>
            </section>
            
            <section style="text-align: center; margin-bottom: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button id="connectDriveBtn" class="btn">üîó Conectar a Drive</button>
                <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
                <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
            </section>

            <section class="filter-bar">
                <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Buscar por nombre, car√°tula, exp, etc." onkeyup="renderAllClientsList()"></div>
                <div class="form-group"><label>Filtrar por Estado</label><select id="estadoFilter" onchange="renderAllClientsList()"><option value="">Todos los estados</option><option value="EJECUCION">Ejecuci√≥n</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA PARCIAL">Finalizada Parcial</option><option value="DEMORADA">Demorada</option></select></div>
            </section>

            <section class="card">
                <h3>üìã Todos los Casos (Ordenados por fecha de revisi√≥n)</h3>
                <div class="reviews-list" id="allClients" style="max-height: 600px;"></div>
            </section>
        </main>
    </div>

    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">
    <input type="file" id="documentUploadInput" style="display: none;" multiple>

    <div id="newClientModal" class="modal"><div class="modal-content"></div></div>
    <div id="clientSelectorModal" class="modal"><div class="modal-content"></div></div>
    <div id="clientInfoModal" class="modal"><div class="modal-content"></div></div>
    
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('documentModal')">&times;</span>
            <h2 id="documentModalTitle"></h2>
            
            <div id="uploadArea" class="upload-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 15px 0; background: #f9f9f9;">
                <p>Arrastra y suelta tus archivos aqu√≠</p>
            </div>
            <ul id="localDocumentList" class="document-list" style="margin-top:10px;">
                <p style="font-style: italic; color: #666;">Archivos listos para subir:</p>
            </ul>

            <h4>Documentos ya guardados en Drive:</h4>
            <ul id="driveDocumentList" class="document-list"></ul>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-info" onclick="triggerLocalFileUpload()">‚ûï Agregar Archivo</button>
                <button class="btn btn-success" onclick="saveDocumentsToDrive()">üì§ Guardar Documentos en Drive</button>
            </div>
        </div>
    </div>
    <div id="vencimientoAlertModal" class="modal"><div class="modal-content"></div></div>
    
    <script>
        let clientsData = [];
        let editingClientId = null, editingField = null, currentClientIdForDocs = null;

        function saveData() {
            localStorage.setItem('planilla_juridica_data', JSON.stringify(clientsData));
            updateDataStatus('‚úÖ Datos guardados localmente');
        }

        function loadData() {
            const savedData = localStorage.getItem('planilla_juridica_data');
            let data = savedData ? JSON.parse(savedData) : [];

            const uniqueClients = new Map();
            data.forEach(client => {
                const key = (client.caratula && String(client.caratula).trim() !== '') ? String(client.caratula).trim().toUpperCase() : client.id;
                if (!uniqueClients.has(key)) {
                    uniqueClients.set(key, client);
                }
            });
            const deduplicatedData = Array.from(uniqueClients.values());

            let statusMessage = savedData ? '‚úÖ Datos cargados' : 'üìã Planilla lista';
            let needsSave = false;
            
            if (deduplicatedData.length < data.length) {
                statusMessage = `‚ö†Ô∏è Se repararon ${data.length - deduplicatedData.length} casos duplicados.`;
                needsSave = true;
            }

            clientsData = sanitizeData(deduplicatedData);
            
            if (needsSave) {
                saveData();
            }
            
            updateDataStatus(statusMessage, needsSave);
        }

        function sanitizeData(data) {
            (data || []).forEach(c => {
                c.id = c.id || generateId(c);
                c.observaciones = Array.isArray(c.observaciones) ? c.observaciones : [];
                c.audiencias_list = Array.isArray(c.audiencias_list) ? c.audiencias_list : [];
                c.vencimientos_list = Array.isArray(c.vencimientos_list) ? c.vencimientos_list : [];

                c.observaciones.forEach(obs => {
                    obs.id = obs.id || generateId({});
                    obs.completed = typeof obs.completed === 'boolean' ? obs.completed : false;
                });
                c.audiencias_list.forEach(aud => {
                    aud.id = aud.id || generateId({});
                    aud.completed = typeof aud.completed === 'boolean' ? aud.completed : false;
                });
                c.vencimientos_list.forEach(venc => {
                    venc.id = venc.id || generateId({});
                    venc.completed = typeof venc.completed === 'boolean' ? venc.completed : false;
                });
                updateClientNextRevision(c);
            });
            return data;
        }

        function updateDataStatus(message, isWarning = false) {
            const el = document.getElementById('dataStatus');
            el.textContent = message;
            el.style.background = isWarning ? '#fff3cd' : '#d4edda';
            el.style.color = isWarning ? '#664d03' : '#155724';
        }
        
        function getTodayYMD() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
        const todayYMD = getTodayYMD();
        function formatDate(dateString) { if (!dateString) return 'No definida'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
        function isToday(dateString) { return dateString && dateString === todayYMD; }
        function isPastDue(dateString) { return dateString && dateString < todayYMD; }
        function getDaysDifference(dateString) { if (!dateString) return 999; const today = new Date(todayYMD); const target = new Date(dateString); return Math.ceil((target - today) / (1000 * 60 * 60 * 24)); }
        
        function generateId(item) { return `EVT_${(item.nombre || 'N').slice(0,3).toUpperCase()}_${Date.now()}`; }
        function getDisplayName(c) { return `${c.nombre || 'Sin Nombre'} | ${c.caratula || 'Sin Car√°tula'} | Exp: ${c.expediente || 'S/N'}`; }

        function updateClientNextRevision(client) {
            const futureObs = (client.observaciones || [])
                .filter(obs => !obs.completed && obs.proximaRevision)
                .sort((a, b) => a.proximaRevision.localeCompare(b.proximaRevision));
            
            if (futureObs.length > 0) {
                client.proximaRevision = futureObs[0].proximaRevision;
                client.observacion = futureObs[0].texto;
                client.fechaTrabajado = futureObs[0].fecha;
            } else {
                client.proximaRevision = '';
                client.observacion = 'No hay tareas pendientes';
                client.fechaTrabajado = '';
            }
        }

        function toggleCompleted(event, clientId, obsId) {
            event.stopPropagation();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const obs = client.observaciones.find(o => o.id === obsId);
            if (!obs) return;
            obs.completed = !obs.completed;
            updateClientNextRevision(client);
            saveData();
            renderAll();
        }

        function toggleAudienceCompleted(event, clientId, audId) {
            event.stopPropagation();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const aud = client.audiencias_list.find(a => a.id === audId);
            if (!aud) return;
            aud.completed = !aud.completed;
            saveData();
            renderAll();
            showClientModal(clientId);
        }

        function toggleVencimientoCompleted(event, clientId, vencId) {
            event.stopPropagation();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const venc = client.vencimientos_list.find(v => v.id === vencId);
            if (!venc) return;
            venc.completed = !venc.completed;
            saveData();
            renderAll();
            showClientModal(clientId);
        }

        function renderAll() {
            clientsData.forEach(updateClientNextRevision);
            renderDashboardLists();
            renderAllClientsList();
        }

        function renderDashboardLists() {
            const allSchedulableItems = clientsData.flatMap(client => {
                const tasks = (client.observaciones || []).filter(obs => !obs.completed && obs.proximaRevision).map(obs => ({ id: obs.id, client: client, reviewDate: obs.proximaRevision, reviewText: obs.texto, isCompletable: true, type: 'task', completed: obs.completed }));
                const audiences = (client.audiencias_list || []).filter(aud => aud.fecha && !aud.completed).map(aud => ({ id: aud.id, client: client, reviewDate: aud.fecha, reviewText: `AUDIENCIA: ${aud.texto}`, isCompletable: true, type: 'audience', completed: aud.completed }));
                const vencimientos = (client.vencimientos_list || []).filter(venc => venc.fecha && !venc.completed).map(venc => ({ id: venc.id, client: client, reviewDate: venc.fecha, reviewText: `VENCIMIENTO: ${venc.texto}`, isCompletable: true, type: 'vencimiento', completed: venc.completed }));
                return [...tasks, ...audiences, ...vencimientos];
            });

            const todayItems = allSchedulableItems.filter(item => isToday(item.reviewDate));
            const overdueItems = allSchedulableItems.filter(item => isPastDue(item.reviewDate)).sort((a, b) => a.reviewDate.localeCompare(b.reviewDate));
            const upcomingItems = allSchedulableItems.filter(item => getDaysDifference(item.reviewDate) > 0).sort((a, b) => a.reviewDate.localeCompare(b.reviewDate));

            renderReviewList('todayReviews', todayItems, 'No hay revisiones para hoy', 'today');
            renderReviewList('overdueReviews', overdueItems, 'No hay revisiones vencidas', 'overdue');
            renderReviewList('upcomingReviews', upcomingItems, 'No hay pr√≥ximas revisiones', 'upcoming');
        }

        function renderReviewList(containerId, items, emptyMsg, type) {
            const container = document.getElementById(containerId);
            const listColor = (type === 'today' || type === 'overdue' || type === 'pending-reviews') ? 'var(--light-text)' : 'rgba(0,0,0,0.6)';
            container.innerHTML = items.length === 0 ? `<p style="color: ${listColor}; text-align: center;">${emptyMsg}</p>` : items.map(item => {
                let dateInfo = '';
                if (type === 'today') dateInfo = 'HOY';
                else if (type === 'overdue') dateInfo = `VENCIDA - ${formatDate(item.reviewDate)}`;
                else dateInfo = `En ${getDaysDifference(item.reviewDate)} d√≠as - ${formatDate(item.reviewDate)}`;
                
                const toggleFunc = item.type === 'task' ? 'toggleCompleted' : item.type === 'audience' ? 'toggleAudienceCompleted' : 'toggleVencimientoCompleted';
                const completedClass = item.completed ? 'completed' : '';
                const completeButton = item.isCompletable ? `<button class="complete-btn" onclick="${toggleFunc}(event, '${item.client.id}', '${item.id}')">‚úî</button>` : `<div style="width:30px; flex-shrink:0;"></div>`;
                
                return `<div class="review-item ${completedClass}">${completeButton}<div class="review-item-content" onclick="showClientModal('${item.client.id}')"><div class="review-date">${dateInfo}</div><div class="review-client">${item.client.nombre} | ${item.client.caratula || 'Sin Car√°tula'}</div><div class="review-obs">${item.reviewText}</div></div></div>`;
            }).join('');
        }
        
        function renderAllClientsList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            const filteredData = clientsData.filter(c => {
                const searchString = `${c.nombre} ${c.caratula} ${c.expediente} ${c.juzgado} ${c.estado}`.toLowerCase();
                const matchesSearch = !searchTerm || searchString.includes(searchTerm);
                const matchesEstado = !estadoFilter || c.estado === estadoFilter;
                return matchesSearch && matchesEstado;
            }).sort((a, b) => (a.proximaRevision || '9999').localeCompare(b.proximaRevision || '9999'));

            document.getElementById('allClients').innerHTML = filteredData.length === 0 ? '<p>No se encontraron casos.</p>' : filteredData.map(c => {
                const hasPendingTask = (c.observaciones || []).some(obs => !obs.completed && obs.proximaRevision);
                const classes = `review-item ${!hasPendingTask ? 'completed' : ''} ${isToday(c.proximaRevision) ? 'today' : ''} ${isPastDue(c.proximaRevision) ? 'overdue' : ''}`;
                return `<div class="${classes}" onclick="showClientModal('${c.id}')"><div class="review-item-content"><div class="review-date">Pr√≥x. Revisi√≥n: ${formatDate(c.proximaRevision)}</div>${c.fechaTrabajado ? `<div style="font-size:0.85em; color:#444; margin-top: 3px;">Trabajado el: ${formatDate(c.fechaTrabajado)}</div>` : ''}<div class="review-client">${getDisplayName(c)}</div><div class="review-obs">√ölt. Tarea: ${c.observacion}</div></div></div>`;
            }).join('');
        }

        function showNewClientModal() { document.getElementById('newClientModal').classList.add('active'); }
        function showClientSelectorModal() {
            const selector = document.getElementById('clientSelector');
            selector.innerHTML = '<option value="">-- Seleccionar Caso --</option>' + [...clientsData].sort((a,b) => (a.nombre || '').localeCompare(b.nombre || '')).map(c => `<option value="${c.id}">${getDisplayName(c)}</option>`).join('');
            document.getElementById('clientSelectorModal').classList.add('active');
        }
        function loadClientInfo() { const clientId = document.getElementById('clientSelector').value; if (clientId) { closeModal('clientSelectorModal'); showClientModal(clientId); } }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); editingClientId = null; editingField = null; }

        function showClientModal(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            updateClientNextRevision(client);
            const content = `
                <span class="close" onclick="closeModal('clientInfoModal')">&times;</span><h2>‚öñÔ∏è ${getDisplayName(client)}</h2>
                <div class="client-info">
                    <h4>üìã Informaci√≥n del Caso</h4>
                    <div class="info-grid">
                        ${Object.entries({nombre: 'Nombre', dni: 'DNI', telefono: 'Tel√©fono', caratula: 'Car√°tula', expediente: 'N¬∞ Expediente', juzgado: 'Juzgado', direccionJuzgado: 'Direcci√≥n Juzgado', telJuzgado: 'Tel. Juzgado', estado: 'Estado', audiencias: 'Audiencias (Campo Antiguo)'}).map(([key, label]) => `
                        <div class="info-item"><div class="info-label">${label}</div><div class="editable-field" id="field-${key}" onclick="editField('${client.id}', '${key}', '${String(client[key] || '').replace(/'/g, '&#39;')}')"><div class="info-value">${client[key] || 'S/D'}</div></div></div>`).join('')}
                        <div class="info-item"><div class="info-label">Pr√≥xima Tarea</div><div class="info-value" style="color: var(--danger-color); font-weight: bold;">${formatDate(client.proximaRevision)}</div></div>
                    </div>
                </div>
                <div class="history-section">
                    <h4>üìù Historial Cronol√≥gico</h4>
                    <div id="history-list-${client.id}" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px;">
                        ${renderHistoryList(client)}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <form class="form-group" onsubmit="addObservation(event, '${client.id}')" style="background: var(--light-bg); padding: 20px; border-radius: 8px;"><h4>‚ûï Agregar Tarea</h4><div class="form-group"><label>Texto</label><textarea id="newObsText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div><button type="submit" class="btn btn-success">üíæ Guardar Tarea</button></form>
                    <form class="form-group" onsubmit="addAudience(event, '${client.id}')" style="background: var(--light-bg); padding: 20px; border-radius: 8px;"><h4>‚ûï Agendar Audiencia</h4><div class="form-group"><label>Descripci√≥n</label><textarea id="newAudienceText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Audiencia</label><input type="date" id="newAudienceDate" required></div><button type="submit" class="btn btn-success">üíæ Agendar</button></form>
                    <form class="form-group" onsubmit="addVencimiento(event, '${client.id}')" style="background: var(--light-bg); padding: 20px; border-radius: 8px;"><h4>‚ûï Agendar Vencimiento</h4><div class="form-group"><label>Descripci√≥n</label><textarea id="newVencimientoText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Vencimiento</label><input type="date" id="newVencimientoDate" required></div><button type="submit" class="btn btn-success">üíæ Agendar</button></form>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="showDocumentModal('${client.id}')">üìÅ Gestionar Documentos</button>
                    <button class="btn" onclick="printClientSheet('${client.id}')">üñ®Ô∏è Imprimir Ficha</button>
                    <button class="btn" onclick="printClientHistory('${client.id}')">üìú Imprimir Historial</button>
                    <button class="btn btn-danger" onclick="deleteClient('${client.id}')">üóëÔ∏è Eliminar Caso</button>
                </div>`;
            document.getElementById('clientInfoModal').querySelector('.modal-content').innerHTML = content;
            document.getElementById('clientInfoModal').classList.add('active');
        }

        function renderHistoryList(client) {
            const tasks = (client.observaciones || []).map(obs => ({ ...obs, date: obs.proximaRevision, type: 'task' }));
            const audiences = (client.audiencias_list || []).map(aud => ({ ...aud, date: aud.fecha, type: 'audience' }));
            const vencimientos = (client.vencimientos_list || []).map(venc => ({ ...venc, date: venc.fecha, type: 'vencimiento' }));
            
            const combinedHistory = [...tasks, ...audiences, ...vencimientos].sort((a, b) => (b.date || '').localeCompare(a.date || ''));

            return combinedHistory.length === 0 ? '<p>No hay historial registrado.</p>' : combinedHistory.map(item => {
                if (item.type === 'task') {
                    return `<div id="task-item-${item.id}" class="history-item history-item-task ${item.completed ? 'completed' : ''}"><div class="history-date">Revisar el: ${formatDate(item.proximaRevision)}${item.fecha ? `<span style="font-weight: normal; color: #444; margin-left: 10px;">(Trabajado el: ${formatDate(item.fecha)})</span>` : ''}<span class="history-tag tag-task" style="margin-left: auto;">TAREA</span></div><div class="history-text">${item.texto}</div><button class="btn btn-sm" onclick="editObs('${client.id}', '${item.id}')">Editar</button><button class="btn btn-danger btn-sm" onclick="deleteObs('${client.id}', '${item.id}')">Eliminar</button></div>`;
                } else if (item.type === 'audience') {
                    return `<div class="history-item history-item-audience ${item.completed ? 'completed' : ''}"><div class="history-date">Fecha: ${formatDate(item.fecha)} <span class="history-tag tag-audience" style="margin-left: auto;">AUDIENCIA</span></div><div class="history-text">${item.texto}</div><button class="btn btn-danger btn-sm" onclick="deleteAudience('${client.id}', '${item.id}')">Eliminar</button></div>`;
                } else {
                     return `<div class="history-item history-item-vencimiento ${item.completed ? 'completed' : ''}"><div class="history-date">Fecha: ${formatDate(item.fecha)} <span class="history-tag tag-vencimiento" style="margin-left: auto;">VENCIMIENTO</span></div><div class="history-text">${item.texto}</div><button class="btn btn-danger btn-sm" onclick="deleteVencimiento('${client.id}', '${item.id}')">Eliminar</button></div>`;
                }
            }).join('');
        }
        
        function editObs(clientId, obsId) {
            const obs = clientsData.find(c => c.id === clientId).observaciones.find(o => o.id === obsId);
            const itemElement = document.getElementById(`task-item-${obsId}`);
            itemElement.innerHTML = `<div class="form-group"><label>Texto</label><textarea id="edit-obs-text-${obsId}" rows="2" class="form-group input">${obs.texto}</textarea></div><div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${obsId}" value="${obs.proximaRevision}" class="form-group input"></div><button class="btn btn-success btn-sm" onclick="saveObsEdit('${clientId}', '${obsId}')">Guardar</button><button class="btn btn-sm" onclick="showClientModal('${clientId}')">Cancelar</button>`;
        }

        function saveObsEdit(clientId, obsId) {
            const client = clientsData.find(c => c.id === clientId);
            const obs = client.observaciones.find(o => o.id === obsId);
            obs.texto = document.getElementById(`edit-obs-text-${obsId}`).value;
            obs.proximaRevision = document.getElementById(`edit-obs-revision-${obsId}`).value;
            obs.fecha = getTodayYMD();
            updateClientNextRevision(client);
            saveData();
            renderAll();
            showClientModal(clientId);
        }
        
        function deleteObs(clientId, obsId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) return;
            const client = clientsData.find(c => c.id === clientId);
            client.observaciones = client.observaciones.filter(o => o.id !== obsId);
            updateClientNextRevision(client);
            saveData();
            renderAll();
            showClientModal(clientId);
        }
        
        function deleteAudience(clientId, audId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta audiencia?')) return;
            const client = clientsData.find(c => c.id === clientId);
            client.audiencias_list = client.audiencias_list.filter(a => a.id !== audId);
            saveData();
            renderAll();
            showClientModal(clientId);
        }

        function deleteVencimiento(clientId, vencId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este vencimiento?')) return;
            const client = clientsData.find(c => c.id === clientId);
            client.vencimientos_list = client.vencimientos_list.filter(v => v.id !== vencId);
            saveData();
            renderAll();
            showClientModal(clientId);
        }

        function editField(clientId, fieldName, currentValue) {
            editingClientId = clientId; editingField = fieldName;
            const fieldElement = document.getElementById(`field-${fieldName}`);
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            fieldElement.innerHTML = ''; fieldElement.appendChild(input); input.focus();
            input.addEventListener('blur', saveField);
            input.addEventListener('keypress', e => { if (e.key === 'Enter') saveField(); });
        }
        function saveField() {
            if (!editingClientId || !editingField) return;
            const client = clientsData.find(c => c.id === editingClientId);
            const input = document.getElementById(`field-${editingField}`).querySelector('input');
            if (client && input) { client[editingField] = input.value; saveData(); renderAll(); showClientModal(editingClientId); }
            editingClientId = null; editingField = null;
        }
        function deleteClient(id) { if (confirm('¬øEst√° seguro de que quiere eliminar este caso y todo su historial? Esta acci√≥n no se puede deshacer.')) { clientsData = clientsData.filter(c => c.id !== id); saveData(); renderAll(); closeModal('clientInfoModal'); } }
        function addObservation(event, clientId) {
            event.preventDefault();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            client.observaciones.push({ id: generateId({}), fecha: getTodayYMD(), texto: document.getElementById('newObsText').value, proximaRevision: document.getElementById('newRevisionDate').value, completed: false });
            updateClientNextRevision(client);
            saveData(); renderAll(); showClientModal(clientId);
        }

        function addAudience(event, clientId) {
            event.preventDefault();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            if (!client.audiencias_list) client.audiencias_list = [];
            client.audiencias_list.push({ id: generateId({}), fecha: document.getElementById('newAudienceDate').value, texto: document.getElementById('newAudienceText').value, completed: false });
            saveData(); renderAll(); showClientModal(clientId);
        }

        function addVencimiento(event, clientId) {
            event.preventDefault();
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            if (!client.vencimientos_list) client.vencimientos_list = [];
            client.vencimientos_list.push({ id: generateId({}), fecha: document.getElementById('newVencimientoDate').value, texto: document.getElementById('newVencimientoText').value, completed: false });
            saveData(); renderAll(); showClientModal(clientId);
        }

        function exportToExcel() {
            const excelData = clientsData.map(c => {
                const allObs = (c.observaciones || []).map(obs => `[TAREA - Rev: ${formatDate(obs.proximaRevision)}]: ${obs.texto}`).join(' \n ');
                const allAuds = (c.audiencias_list || []).map(aud => `[AUDIENCIA - Fecha: ${formatDate(aud.fecha)}]: ${aud.texto}`).join(' \n ');
                const allVencs = (c.vencimientos_list || []).map(venc => `[VENCIMIENTO - Fecha: ${formatDate(venc.fecha)}]: ${venc.texto}`).join(' \n ');
                return { 'Nombre': c.nombre, 'DNI': c.dni, 'Tel√©fono': c.telefono, 'Car√°tula': c.caratula, 'Expediente': c.expediente, 'Juzgado': c.juzgado, 'Direcci√≥n Juzgado': c.direccionJuzgado, 'Tel. Juzgado': c.telJuzgado, 'Estado': c.estado, 'Pr√≥xima Revisi√≥n': formatDate(c.proximaRevision), '√öltima Tarea': c.observacion, 'Audiencias (Campo Antiguo)': c.audiencias, 'Historial Tareas': allObs, 'Historial Audiencias': allAuds, 'Historial Vencimientos': allVencs };
            });
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Casos Familia');
            XLSX.writeFile(workbook, `Casos_Familia_${getTodayYMD()}.xlsx`);
        }
        function exportData() { const dataStr = JSON.stringify(clientsData, null, 2); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'})); link.download = `casos_familia_${getTodayYMD()}.json`; link.click(); }
        function importData() { document.getElementById('importInput').click(); }
        function handleImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported) && confirm(`¬øImportar ${imported.length} casos? Esto sobreescribir√° los datos actuales.`)) { clientsData = imported; saveData(); loadData(); renderAll(); } } catch (err) { alert('Error al importar el archivo. Verifique que sea un JSON v√°lido.'); } };
            reader.readAsText(file); event.target.value = '';
        }

        function printClientSheet(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const printContent = `<div class="print-area"><h2>Ficha del Caso</h2><h3>${getDisplayName(client)}</h3><div class="info-grid">${Object.entries({nombre: 'Nombre', dni: 'DNI', telefono: 'Tel√©fono', caratula: 'Car√°tula', expediente: 'N¬∞ Expediente', juzgado: 'Juzgado', direccionJuzgado: 'Direcci√≥n Juzgado', telJuzgado: 'Tel. Juzgado', estado: 'Estado', audiencias: 'Audiencias (Campo Antiguo)'}).map(([key, label]) => `<div class="info-item"><div class="info-label">${label}</div><div class="info-value">${client[key] || 'S/D'}</div></div>`).join('')}</div></div>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Ficha del Cliente</title><style>${document.querySelector("style").innerHTML}</style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function printClientHistory(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            const historyHTML = renderHistoryListForPrint(client);
            const printContent = `<div class="print-area"><h2>Historial de Actuaciones</h2><h3>${getDisplayName(client)}</h3>${historyHTML}</div>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Historial del Caso</title><style>${document.querySelector("style").innerHTML}</style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function renderHistoryListForPrint(client) {
            const tasks = (client.observaciones || []).map(obs => ({ ...obs, date: obs.proximaRevision, type: 'task' }));
            const audiences = (client.audiencias_list || []).map(aud => ({ ...aud, date: aud.fecha, type: 'audience' }));
            const vencimientos = (client.vencimientos_list || []).map(venc => ({ ...venc, date: venc.fecha, type: 'vencimiento' }));
            
            const combinedHistory = [...tasks, ...audiences, ...vencimientos].sort((a, b) => (b.date || '').localeCompare(a.date || ''));

            return combinedHistory.length === 0 ? '<p>No hay historial registrado.</p>' : combinedHistory.map(item => {
                if (item.type === 'task') {
                    return `<div class="history-item history-item-task ${item.completed ? 'completed' : ''}"><div class="history-date">Revisar el: ${formatDate(item.proximaRevision)}${item.fecha ? `(Trabajado el: ${formatDate(item.fecha)})` : ''}<span class="history-tag tag-task">TAREA</span></div><div class="history-text">${item.texto}</div></div>`;
                } else if (item.type === 'audience'){
                    return `<div class="history-item history-item-audience"><div class="history-date">Fecha: ${formatDate(item.fecha)} <span class="history-tag tag-audience">AUDIENCIA</span></div><div class="history-text">${item.texto}</div></div>`;
                } else {
                    return `<div class="history-item history-item-vencimiento"><div class="history-date">Fecha: ${formatDate(item.fecha)} <span class="history-tag tag-vencimiento">VENCIMIENTO</span></div><div class="history-text">${item.texto}</div></div>`;
                }
            }).join('');
        }
        
        function checkVencimientosDelDia() {
            const vencimientosHoy = clientsData.flatMap(client => 
                (client.vencimientos_list || [])
                .filter(venc => isToday(venc.fecha) && !venc.completed)
                .map(venc => ({ client, venc }))
            );

            if (vencimientosHoy.length > 0) {
                const modal = document.getElementById('vencimientoAlertModal');
                const content = `<span class="close" onclick="closeModal('vencimientoAlertModal')">&times;</span><h2>‚ö†Ô∏è ¬°Alerta de Vencimientos para Hoy!</h2><div class="reviews-list" style="max-height: 60vh;">${vencimientosHoy.map(item => `<div class="review-item today"><div class="review-item-content" onclick="showClientModal('${item.client.id}')"><div class="review-client">${getDisplayName(item.client)}</div><div class="review-obs"><strong>Vencimiento:</strong> ${item.venc.texto}</div></div></div>`).join('')}</div><div style="text-align:center; margin-top: 20px;"><button class="btn btn-warning" onclick="closeModal('vencimientoAlertModal')">Entendido</button></div>`;
                modal.querySelector('.modal-content').innerHTML = content;
                modal.classList.add('active');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newClientModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('newClientModal')">&times;</span><h2>‚ûï Agregar Nuevo Caso</h2><form id="newClientForm"><div class="info-grid" style="grid-template-columns: 1fr 1fr;"><div class="form-group"><label>Nombre *</label><input type="text" id="newNombre" required></div><div class="form-group"><label>DNI</label><input type="text" id="newDni"></div><div class="form-group"><label>Tel√©fono</label><input type="text" id="newTelefono"></div><div class="form-group"><label>Car√°tula</label><input type="text" id="newCaratula"></div><div class="form-group"><label>N¬∞ Expediente</label><input type="text" id="newExpediente"></div><div class="form-group"><label>Juzgado</label><input type="text" id="newJuzgado"></div><div class="form-group"><label>Direcci√≥n Juzgado</label><input type="text" id="newDireccionJuzgado"></div><div class="form-group"><label>Tel. Juzgado</label><input type="text" id="newTelJuzgado"></div><div class="form-group"><label>Estado *</label><select id="newEstado" required><option value="EJECUCION">Ejecuci√≥n</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA PARCIAL">Finalizada Parcial</option><option value="DEMORADA">Demorada</option></select></div><div class="form-group"><label>Audiencias (Texto simple)</label><input type="text" id="newAudiencias"></div></div><div class="form-group" style="margin-top:20px;"><label>Tarea Inicial (Opcional)</label><textarea id="newObservacion" rows="3"></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n para Tarea Inicial</label><input type="date" id="newFechaRevision"></div><div style="text-align:center;"><button type="submit" class="btn btn-success">üíæ Guardar Caso</button></div></form>`;
            document.getElementById('clientSelectorModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('clientSelectorModal')">&times;</span><h2>üëÅÔ∏è Seleccionar Caso</h2><div class="form-group"><select id="clientSelector" onchange="loadClientInfo()"></select></div>`;
            
            document.getElementById('newClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const caratulaInput = document.getElementById('newCaratula');
                const caratulaValue = caratulaInput.value.trim();
                if (caratulaValue && clientsData.some(client => client.caratula && client.caratula.trim().toUpperCase() === caratulaValue.toUpperCase())) {
                    alert(`Error: Ya existe un caso con la car√°tula "${caratulaValue}".\nPor favor, verifique los datos.`);
                    return;
                }
                const newClient = { id: generateId({}), nombre: document.getElementById('newNombre').value.toUpperCase(), dni: document.getElementById('newDni').value, telefono: document.getElementById('newTelefono').value, caratula: caratulaValue, expediente: document.getElementById('newExpediente').value.trim(), juzgado: document.getElementById('newJuzgado').value, direccionJuzgado: document.getElementById('newDireccionJuzgado').value, telJuzgado: document.getElementById('newTelJuzgado').value, estado: document.getElementById('newEstado').value, audiencias: document.getElementById('newAudiencias').value, observaciones: [], audiencias_list: [], vencimientos_list: [] };
                const obsText = document.getElementById('newObservacion').value;
                const revDate = document.getElementById('newFechaRevision').value;
                if (obsText && revDate) {
                    newClient.observaciones.push({ id: generateId({}), fecha: getTodayYMD(), texto: obsText, proximaRevision: revDate, completed: false });
                }
                updateClientNextRevision(newClient);
                clientsData.push(newClient);
                saveData();
                renderAll();
                closeModal('newClientModal');
                e.target.reset();
            });

            loadData();
            renderAll();
            checkVencimientosDelDia();
        });
        window.addEventListener('click', e => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DATA_FILE_NAME = 'datos_planilla_juridica.json';
        const DOCS_FOLDER_NAME = 'Planilla_Juridica_Documentos';

        let tokenClient, gapiInited = false, gisInited = false, dataFileId = null, docsFolderId = null;
        const driveStatusEl = document.getElementById('driveStatus'), connectDriveBtn = document.getElementById('connectDriveBtn'), saveToDriveBtn = document.getElementById('saveToDriveBtn'), loadFromDriveBtn = document.getElementById('loadFromDriveBtn');

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; maybeEnableButtons(); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
        function maybeEnableButtons() { if (gapiInited && gisInited) connectDriveBtn.onclick = handleAuthClick; }
        function updateDriveStatus(message, isConnected = false) { driveStatusEl.style.display = 'block'; driveStatusEl.textContent = message; driveStatusEl.style.background = isConnected ? '#d1e7dd' : '#fff3cd'; driveStatusEl.style.color = isConnected ? '#0f5132' : '#664d03'; }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw (resp);
                updateDriveStatus('‚úÖ Conectado a Google Drive', true);
                connectDriveBtn.style.display = 'none'; saveToDriveBtn.style.display = 'inline-block'; loadFromDriveBtn.style.display = 'inline-block';
                saveToDriveBtn.onclick = saveDataToDrive; loadFromDriveBtn.onclick = loadDataFromDrive;
                await findDataFile();
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); else tokenClient.requestAccessToken({prompt: ''});
        }
        async function findDataFile() {
            updateDriveStatus('Buscando archivo de datos en Drive...', false);
            try {
                const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
                if (response.result.files.length > 0) { dataFileId = response.result.files[0].id; updateDriveStatus('‚úÖ Archivo de datos encontrado en Drive.', true); }
                else { updateDriveStatus('‚ö†Ô∏è Archivo no encontrado. Se crear√° uno nuevo al guardar.', false); dataFileId = null; }
            } catch (err) { console.error(err); alert('Error al buscar el archivo de datos en Drive.'); }
        }
        async function saveDataToDrive() {
            if (!confirm('¬øGuardar los datos actuales en Google Drive? Esto sobreescribir√° la versi√≥n anterior en la nube.')) return;
            updateDriveStatus('Guardando datos en Drive...', false);
            try {
                const content = JSON.stringify(clientsData, null, 2);
                dataFileId = await uploadContent(content, DATA_FILE_NAME, 'application/json', null, dataFileId);
                updateDriveStatus('‚úÖ ¬°Datos guardados en Drive con √©xito!', true);
            } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al guardar en Drive.', false); }
        }
        async function loadDataFromDrive() {
            if (!dataFileId) return alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno.");
            if (!confirm("¬øSeguro? Se reemplazar√°n los datos locales con los de Drive.")) return;
            updateDriveStatus('Cargando datos desde Drive...', false);
            try {
                const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
                const importedData = JSON.parse(response.body);
                if (!Array.isArray(importedData)) throw new Error('Formato no v√°lido.');
                clientsData = importedData;
                saveData();
                loadData();
                renderAll();
                updateDriveStatus('‚úÖ Datos cargados desde Drive con √©xito.', true);
            } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al cargar desde Drive.', false); alert('Error al cargar desde Drive: ' + err.message); }
        }

        // ==================================================================
        // INICIO DEL NUEVO BLOQUE DE C√ìDIGO PARA MANEJO DE DOCUMENTOS
        // ==================================================================

        let localFilesForUpload = [];

        async function showDocumentModal(clientId) {
            if (gapi.client.getToken() === null) {
                return alert('Para gestionar documentos, primero debes conectar con Google Drive.');
            }
            currentClientIdForDocs = clientId;
            localFilesForUpload = []; 

            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('documentModalTitle').innerText = `Documentos de: ${getDisplayName(client)}`;
            document.getElementById('documentModal').classList.add('active');
            
            renderLocalFileList();
            await renderDriveFileList();

            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const area = document.getElementById('uploadArea');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => area.addEventListener(eName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false));
            ['dragenter', 'dragover'].forEach(eName => area.addEventListener(eName, () => area.classList.add('drag-over'), false));
            ['dragleave', 'drop'].forEach(eName => area.addEventListener(eName, () => area.classList.remove('drag-over'), false));
            area.addEventListener('drop', e => processFiles(e.dataTransfer.files), false);
        }

        function processFiles(files) {
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newFile = {
                        id: 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        type: file.type || 'Desconocido',
                        size: file.size,
                        dataUrl: e.target.result
                    };
                    localFilesForUpload.push(newFile);
                    renderLocalFileList();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function renderLocalFileList() {
            const listEl = document.getElementById('localDocumentList');
            if (localFilesForUpload.length === 0) {
                listEl.innerHTML = '<p style="font-style: italic; color: #666; text-align:center; padding:10px;">No hay archivos nuevos para subir.</p>';
                return;
            }
            listEl.innerHTML = '<p style="font-style: italic; color: #666;">Archivos listos para subir:</p>';
            listEl.innerHTML += localFilesForUpload.map(file => `
                <li>
                    <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button class="btn btn-danger btn-sm" onclick="removeLocalFile('${file.id}')">X</button>
                </li>
            `).join('');
        }
        
        function removeLocalFile(fileId) {
            localFilesForUpload = localFilesForUpload.filter(f => f.id !== fileId);
            renderLocalFileList();
        }

        function triggerLocalFileUpload() {
            const uploader = document.getElementById('documentUploadInput');
            uploader.onchange = (e) => processFiles(e.target.files);
            uploader.value = '';
            uploader.click();
        }

        async function saveDocumentsToDrive() {
            if (localFilesForUpload.length === 0) {
                alert("No hay archivos nuevos para guardar. Arrastre archivos al √°rea designada o use el bot√≥n 'Agregar Archivo'.");
                return;
            }

            const driveListEl = document.getElementById('driveDocumentList');
            driveListEl.innerHTML += '<div class="spinner"></div><p style="text-align:center;">Subiendo archivos...</p>';

            const client = clientsData.find(c => c.id === currentClientIdForDocs);
            const clientFolderName = `${client.nombre.replace(/[\/\\?%*:|"<>]/g, '-')} - Exp ${client.expediente || client.id.slice(-4)}`;
            
            try {
                if (!docsFolderId) docsFolderId = await getOrCreateFolder(DOCS_FOLDER_NAME);
                const clientFolderId = await getOrCreateFolder(clientFolderName, docsFolderId);
                
                for (let i = 0; i < localFilesForUpload.length; i++) {
                    const file = localFilesForUpload[i];
                    document.getElementById('documentModalTitle').innerText = `Subiendo ${i+1}/${localFilesForUpload.length}: ${file.name}`;
                    await uploadContent(file.dataUrl, file.name, file.type, clientFolderId, null);
                }
                
                localFilesForUpload = [];
                renderLocalFileList();
                await renderDriveFileList();
                document.getElementById('documentModalTitle').innerText = `Documentos de: ${getDisplayName(client)}`;

            } catch (err) {
                console.error(err);
                alert("Error al subir los archivos.");
                await renderDriveFileList();
            }
        }
        
        async function renderDriveFileList() {
            const listEl = document.getElementById('driveDocumentList');
            listEl.innerHTML = '<div class="spinner"></div>';
            try {
                const client = clientsData.find(c => c.id === currentClientIdForDocs);
                if (!docsFolderId) docsFolderId = await getOrCreateFolder(DOCS_FOLDER_NAME);
                const clientFolderName = `${client.nombre.replace(/[\/\\?%*:|"<>]/g, '-')} - Exp ${client.expediente || client.id.slice(-4)}`;
                const clientFolderId = await getOrCreateFolder(clientFolderName, docsFolderId);
                
                const response = await gapi.client.drive.files.list({
                    q: `'${clientFolderId}' in parents and trashed=false`,
                    fields: 'files(id, name, webViewLink)'
                });
                
                if (response.result.files.length === 0) {
                    listEl.innerHTML = '<li>No hay documentos guardados en Drive para este caso.</li>';
                } else {
                    listEl.innerHTML = response.result.files.map(file => `
                        <li>
                            <a href="${file.webViewLink}" target="_blank">${file.name}</a>
                            <button class="btn btn-danger btn-sm" onclick="deleteDocument('${file.id}')">X</button>
                        </li>`).join('');
                }
            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<li>Error al cargar documentos de Drive.</li>';
            }
        }

        async function deleteDocument(fileId) {
            if (confirm('¬øEliminar este documento permanentemente de Google Drive?')) {
                try {
                    await gapi.client.drive.files.delete({ fileId });
                    await renderDriveFileList();
                } catch (err) {
                    alert('Error al eliminar el documento.');
                }
            }
        }

        async function getOrCreateFolder(name, parentId = null) {
            let query = `mimeType='application/vnd.google-apps.folder' and name='${name}' and trashed=false`;
            if (parentId) {
                query += ` and '${parentId}' in parents`;
            }
            const response = await gapi.client.drive.files.list({ q: query, fields: 'files(id)' });
            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            }
            const fileMetadata = { name, mimeType: 'application/vnd.google-apps.folder', ...(parentId && {parents: [parentId]}) };
            const newFolder = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
            return newFolder.result.id;
        }

        async function uploadContent(content, fileName, mimeType, parentId, fileIdToUpdate) {
            const boundary = '-------314159265358979323846';
            const metadata = { name: fileName, mimeType: mimeType, ...(parentId && !fileIdToUpdate && { parents: [parentId] }) };
            let base64Data;
            if (typeof content === 'string' && content.startsWith('data:')) {
                base64Data = content.split(',')[1];
            } else {
                base64Data = btoa(unescape(encodeURIComponent(content)));
            }
            const requestBody =
                `--${boundary}\r\n` +
                `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
                JSON.stringify(metadata) +
                `\r\n--${boundary}\r\n` +
                `Content-Type: ${mimeType}\r\n` +
                `Content-Transfer-Encoding: base64\r\n\r\n` +
                base64Data +
                `\r\n--${boundary}--`;
            const request = gapi.client.request({
                path: fileIdToUpdate ? `/upload/drive/v3/files/${fileIdToUpdate}` : '/upload/drive/v3/files',
                method: fileIdToUpdate ? 'PATCH' : 'POST',
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
                body: requestBody
            });
            const response = await request;
            return response.result.id;
        }

        // ==================================================================
        // FIN DEL NUEVO BLOQUE DE C√ìDIGO
        // ==================================================================
    </script>
</body>
</html>
