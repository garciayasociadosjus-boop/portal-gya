<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Siniestros</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #c0392b; /* Rojo oscuro para siniestros */
            --secondary-color: #e74c3c; /* Rojo m√°s claro */
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --light-text: #ffffff;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%); /* Tonos grises/oscuros */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: var(--light-text); border-radius: var(--border-radius);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text); padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-content { padding: 30px; }
        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-bottom: 40px;
        }
        .card {
            background: var(--light-text); border-radius: var(--border-radius); padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
        .card h3 {
            color: var(--dark-text); margin-bottom: 20px; font-size: 1.3em;
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--light-bg); padding-bottom: 10px;
        }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .today-reviews { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: var(--light-text); }
        .overdue-reviews { background: linear-gradient(135deg, #e74c3c, #c0392b); color: var(--light-text); }
        .pending-reviews { background: linear-gradient(135deg, #feca57, #ff9f43); color: var(--light-text); }
        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text); border: none; padding: 12px 24px; border-radius: 8px;
            cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 5px;
            text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(192, 57, 43, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #27ae60); }
        .btn-info { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark-text); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
        }
        .reviews-list { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .review-item {
            background: #f8f9fa; border-left: 4px solid var(--secondary-color); padding: 15px;
            margin-bottom: 10px; border-radius: 0 8px 8px 0; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px;
        }
        .review-item-content { flex-grow: 1; cursor: pointer; }
        .review-item.completed .review-item-content { text-decoration: line-through; opacity: 0.6; }
        .review-item.completed { border-left-color: var(--success-color); background-color: #f2fdf5; }
        .review-item:hover { background: #fee; transform: translateX(5px); }
        .review-item.today { border-left-color: #ff7e5f; background: #fff5f5; }
        .review-item.overdue { border-left-color: var(--danger-color); background: #fef9e7; }
        .review-date { font-weight: 600; color: var(--dark-text); font-size: 1.1em; }
        .review-client { font-size: 1em; color: var(--primary-color); margin: 5px 0; font-weight: 500; }
        .review-obs { font-size: 0.9em; color: #666; font-style: italic; }
        .complete-btn {
            background: #e0e0e0; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            font-size: 16px; flex-shrink: 0; line-height: 30px;
        }
        .complete-btn:hover { background: #c0c0c0; }
        .review-item.completed .complete-btn { background: var(--success-color); color: var(--light-text); }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--light-text); border-radius: var(--border-radius); padding: 30px; width: 95%;
            max-width: 900px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .client-info { background: var(--light-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .client-info h4 { color: var(--dark-text); margin-bottom: 15px; font-size: 1.2em; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .info-grid.full-width > .info-item { grid-column: 1 / -1; }
        .info-item { background: var(--light-text); padding: 12px; border-radius: 5px; border-left: 3px solid var(--primary-color); }
        .info-label { font-size: 0.8em; color: #666; text-transform: uppercase; font-weight: 600; }
        .info-value { font-size: 1em; color: var(--dark-text); margin-top: 2px; font-weight: 500; }
        .editable-field { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.3s ease; min-height: 20px; }
        .editable-field:hover { background-color: #fdd; color: var(--primary-color); }
        .history-section { margin-top: 20px; }
        .history-item { background: var(--light-text); border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; border-left: 5px solid var(--secondary-color);}
        .history-date { font-size: 0.9em; color: var(--primary-color); font-weight: 600; margin-bottom: 5px; }
        .history-text { color: var(--dark-text); }
        .close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .data-status {
            background: #d4edda; border: 1px solid #c3e6cb; color: #155724;
            padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;
        }
        .filter-bar {
            background: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        
        /* --- ESTILOS DE IMPRESI√ìN --- */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .print-area h2, .print-area h3, .print-area h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
            .print-area .info-grid { display: block; }
            .print-area .info-item { border: 1px solid #eee; padding: 8px; margin-bottom: 5px; page-break-inside: avoid; }
            .print-area .history-item { border: 1px solid #eee; padding: 8px; margin-bottom: 5px; page-break-inside: avoid; }
            .print-area .btn, .print-area .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üöó Planilla de Siniestros</h1>
            <p>Gesti√≥n de Reclamos y Siniestros</p>
        </header>

        <main class="main-content">
            <div id="dataStatus" class="data-status">Cargando datos...</div>
            
            <section class="dashboard">
                <div class="card today-reviews"><h3><i class="icon"></i>Revisiones de Hoy</h3><div class="reviews-list" id="todayReviews"></div></div>
                <div class="card overdue-reviews"><h3><i class="icon"></i>Revisiones Vencidas</h3><div class="reviews-list" id="overdueReviews"></div></div>
                <div class="card pending-reviews"><h3><i class="icon"></i>Pr√≥ximas Revisiones</h3><div class="reviews-list" id="upcomingReviews"></div></div>
            </section>

            <section style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-success" onclick="showNewClaimModal()">‚ûï Agregar Siniestro</button>
                <button class="btn" onclick="showClaimSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-info" onclick="exportData()">üíæ Exportar JSON</button>
                <button class="btn btn-warning" onclick="importData()">üì• Importar Datos</button>
            </section>
            
            <section class="filter-bar">
                <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Buscar por cliente, aseguradora, n¬∞ reclamo..." onkeyup="renderAllClaimsList()"></div>
                <div class="form-group"><label>Filtrar por Estado</label><select id="estadoFilter" onchange="renderAllClaimsList()"><option value="">Todos</option><option value="EJECUCION">Ejecuci√≥n</option><option value="FINALIZADA">Finalizada</option><option value="RECHAZADO">Rechazado</option><option value="DEMORADA">Demorada</option></select></div>
            </section>

            <section class="card">
                <h3>üìã Todos los Siniestros (Ordenados por fecha de revisi√≥n)</h3>
                <div class="reviews-list" id="allClaims" style="max-height: 600px;"></div>
            </section>
        </main>
    </div>

    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">

    <div id="newClaimModal" class="modal"><div class="modal-content"></div></div>
    <div id="claimSelectorModal" class="modal"><div class="modal-content"></div></div>
    <div id="claimInfoModal" class="modal"><div class="modal-content"></div></div>
    
    <script>
        let claimsData = [];
        let editingClaimId = null, editingField = null;

        function saveData() {
            localStorage.setItem('planilla_siniestros_data', JSON.stringify(claimsData));
            updateDataStatus('‚úÖ Datos guardados localmente');
        }

        function loadData() {
            const savedData = localStorage.getItem('planilla_siniestros_data');
            let data = savedData ? JSON.parse(savedData) : [];
            
            claimsData = sanitizeData(data);
            
            let statusMessage = savedData ? '‚úÖ Datos cargados' : 'üìã Planilla lista';
            updateDataStatus(statusMessage);
        }

        function sanitizeData(data) {
            (data || []).forEach(c => {
                c.id = c.id || generateId(c);
                c.observaciones = Array.isArray(c.observaciones) ? c.observaciones : [];
                c.observaciones.forEach(obs => {
                    obs.id = obs.id || generateId({});
                    obs.completed = typeof obs.completed === 'boolean' ? obs.completed : false;
                });
                updateClaimNextRevision(c);
            });
            return data;
        }

        function updateDataStatus(message, isWarning = false) {
            const el = document.getElementById('dataStatus');
            el.textContent = message;
            el.style.background = isWarning ? '#fff3cd' : '#d4edda';
            el.style.color = isWarning ? '#664d03' : '#155724';
        }
        
        function getTodayYMD() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
        const todayYMD = getTodayYMD();
        function formatDate(dateString) { if (!dateString) return 'No definida'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
        function isToday(dateString) { return dateString && dateString === todayYMD; }
        function isPastDue(dateString) { return dateString && dateString < todayYMD; }
        function getDaysDifference(dateString) { if (!dateString) return 999; const today = new Date(todayYMD); const target = new Date(dateString); return Math.ceil((target - today) / (1000 * 60 * 60 * 24)); }
        
        function generateId(item) { return `SIN_${(item.cliente || 'S').slice(0,3).toUpperCase()}_${Date.now()}`; }
        function getDisplayName(c) { return `${c.cliente || 'Sin Cliente'} | Cia. Contraria: ${c.contra || 'S/C'} | Reclamo: ${c.numeroReclamo || 'S/N'}`; }

        function updateClaimNextRevision(claim) {
            const futureObs = (claim.observaciones || [])
                .filter(obs => !obs.completed && obs.proximaRevision)
                .sort((a, b) => a.proximaRevision.localeCompare(b.proximaRevision));
            
            if (futureObs.length > 0) {
                claim.fechaRevision = futureObs[0].proximaRevision;
                claim.observacion = futureObs[0].texto;
            } else {
                claim.fechaRevision = '';
                claim.observacion = 'No hay tareas pendientes';
            }
        }

        function toggleCompleted(event, claimId, obsId) {
            event.stopPropagation();
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            const obs = claim.observaciones.find(o => o.id === obsId);
            if (!obs) return;
            obs.completed = !obs.completed;
            updateClaimNextRevision(claim);
            saveData();
            renderAll();
        }

        function renderAll() {
            claimsData.forEach(updateClaimNextRevision);
            renderDashboardLists();
            renderAllClaimsList();
        }

        function renderDashboardLists() {
            const allTasks = claimsData.flatMap(claim => 
                (claim.observaciones || [])
                    .filter(obs => !obs.completed && obs.proximaRevision)
                    .map(obs => ({ id: obs.id, claim: claim, reviewDate: obs.proximaRevision, reviewText: obs.texto }))
            );

            const todayItems = allTasks.filter(item => isToday(item.reviewDate));
            const overdueItems = allTasks.filter(item => isPastDue(item.reviewDate)).sort((a, b) => a.reviewDate.localeCompare(b.reviewDate));
            const upcomingItems = allTasks.filter(item => getDaysDifference(item.reviewDate) > 0).sort((a, b) => a.reviewDate.localeCompare(b.reviewDate));

            renderReviewList('todayReviews', todayItems, 'No hay revisiones para hoy', 'today');
            renderReviewList('overdueReviews', overdueItems, 'No hay revisiones vencidas', 'overdue');
            renderReviewList('upcomingReviews', upcomingItems, 'No hay pr√≥ximas revisiones', 'upcoming');
        }

        function renderReviewList(containerId, items, emptyMsg, type) {
            const container = document.getElementById(containerId);
            const listColor = (type === 'today' || type === 'overdue' || type === 'pending-reviews') ? 'var(--light-text)' : 'rgba(0,0,0,0.6)';
            container.innerHTML = items.length === 0 ? `<p style="color: ${listColor}; text-align: center;">${emptyMsg}</p>` : items.map(item => {
                let dateInfo = '';
                if (type === 'today') dateInfo = 'HOY';
                else if (type === 'overdue') dateInfo = `VENCIDA - ${formatDate(item.reviewDate)}`;
                else dateInfo = `En ${getDaysDifference(item.reviewDate)} d√≠as - ${formatDate(item.reviewDate)}`;
                
                return `<div class="review-item"><button class="complete-btn" onclick="toggleCompleted(event, '${item.claim.id}', '${item.id}')">‚úî</button><div class="review-item-content" onclick="showClaimModal('${item.claim.id}')"><div class="review-date">${dateInfo}</div><div class="review-client">${item.claim.cliente} | ${item.claim.contra || 'S/C'}</div><div class="review-obs">${item.reviewText}</div></div></div>`;
            }).join('');
        }
        
        function renderAllClaimsList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            const filteredData = claimsData.filter(c => {
                const searchString = `${c.cliente} ${c.contra} ${c.numeroReclamo} ${c.aseguradoEn} ${c.estado}`.toLowerCase();
                const matchesSearch = !searchTerm || searchString.includes(searchTerm);
                const matchesEstado = !estadoFilter || c.estado === estadoFilter;
                return matchesSearch && matchesEstado;
            }).sort((a, b) => (a.fechaRevision || '9999').localeCompare(b.fechaRevision || '9999'));

            document.getElementById('allClaims').innerHTML = filteredData.length === 0 ? '<p>No se encontraron siniestros.</p>' : filteredData.map(c => {
                const hasPendingTask = (c.observaciones || []).some(obs => !obs.completed && obs.proximaRevision);
                const classes = `review-item ${!hasPendingTask ? 'completed' : ''} ${isToday(c.fechaRevision) ? 'today' : ''} ${isPastDue(c.fechaRevision) ? 'overdue' : ''}`;
                return `<div class="${classes}" onclick="showClaimModal('${c.id}')"><div class="review-item-content"><div class="review-date">Pr√≥x. Revisi√≥n: ${formatDate(c.fechaRevision)}</div><div class="review-client">${getDisplayName(c)}</div><div class="review-obs">√ölt. Tarea: ${c.observacion}</div></div></div>`;
            }).join('');
        }

        function showNewClaimModal() { document.getElementById('newClaimModal').classList.add('active'); }
        function showClaimSelectorModal() {
            const selector = document.getElementById('claimSelector');
            selector.innerHTML = '<option value="">-- Seleccionar Siniestro --</option>' + [...claimsData].sort((a,b) => (a.cliente || '').localeCompare(b.cliente || '')).map(c => `<option value="${c.id}">${getDisplayName(c)}</option>`).join('');
            document.getElementById('claimSelectorModal').classList.add('active');
        }
        function loadClaimInfo() { const claimId = document.getElementById('claimSelector').value; if (claimId) { closeModal('claimSelectorModal'); showClaimModal(claimId); } }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); editingClaimId = null; editingField = null; }

        function showClaimModal(claimId) {
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            updateClaimNextRevision(claim);
            const content = `
                <span class="close" onclick="closeModal('claimInfoModal')">&times;</span><h2>üöó ${getDisplayName(claim)}</h2>
                <div class="client-info">
                    <h4>üìã Informaci√≥n del Siniestro</h4>
                    <div class="info-grid">
                        ${Object.entries({cliente: 'Cliente', dni: 'DNI', celular: 'Celular', aseguradoEn: 'Asegurado en', contra: 'Cia. Contraria', numeroReclamo: 'N¬∞ Reclamo', presupuesto: 'Presupuesto', indemnizacion: 'Indemnizaci√≥n', honorarios: 'Honorarios', acuerdo: 'Acuerdo', fechaPago: 'Fecha Pago', factura: 'Factura', estado: 'Estado'}).map(([key, label]) => `
                        <div class="info-item"><div class="info-label">${label}</div><div class="editable-field" id="field-${key}" onclick="editField('${claim.id}', '${key}', '${String(claim[key] || '').replace(/'/g, '&#39;')}')"><div class="info-value">${claim[key] || 'S/D'}</div></div></div>`).join('')}
                        <div class="info-item"><div class="info-label">Pr√≥xima Revisi√≥n</div><div class="info-value" style="color: var(--danger-color); font-weight: bold;">${formatDate(claim.fechaRevision)}</div></div>
                    </div>
                </div>
                <div class="history-section">
                    <h4>üìù Historial de Observaciones</h4>
                    <div id="history-list-${claim.id}" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px;">
                        ${renderHistoryList(claim)}
                    </div>
                </div>
                <form class="form-group" onsubmit="addObservation(event, '${claim.id}')" style="background: var(--light-bg); padding: 20px; border-radius: 8px;"><h4>‚ûï Agregar Tarea/Observaci√≥n</h4><div class="form-group"><label>Texto</label><textarea id="newObsText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div><button type="submit" class="btn btn-success">üíæ Guardar Tarea</button></form>
                <div class="action-buttons">
                    <button class="btn" onclick="printClaimSheet('${claim.id}')">üñ®Ô∏è Imprimir Ficha</button>
                    <button class="btn" onclick="printClaimHistory('${claim.id}')">üìú Imprimir Historial</button>
                    <button class="btn btn-danger" onclick="deleteClaim('${claim.id}')">üóëÔ∏è Eliminar Siniestro</button>
                </div>`;
            document.getElementById('claimInfoModal').querySelector('.modal-content').innerHTML = content;
            document.getElementById('claimInfoModal').classList.add('active');
        }

        function renderHistoryList(claim) {
            const history = [...(claim.observaciones || [])].sort((a, b) => (b.proximaRevision || '').localeCompare(a.proximaRevision || ''));
            return history.length === 0 ? '<p>No hay observaciones registradas.</p>' : history.map(item => {
                return `<div id="task-item-${item.id}" class="history-item ${item.completed ? 'completed' : ''}">
                    <div class="history-date">Revisar el: ${formatDate(item.proximaRevision)}</div>
                    <div class="history-text">${item.texto}</div>
                    <button class="btn btn-sm" onclick="editObs('${claim.id}', '${item.id}')">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteObs('${claim.id}', '${item.id}')">Eliminar</button>
                </div>`;
            }).join('');
        }
        
        function editObs(claimId, obsId) {
            const obs = claimsData.find(c => c.id === claimId).observaciones.find(o => o.id === obsId);
            const itemElement = document.getElementById(`task-item-${obsId}`);
            itemElement.innerHTML = `
                <div class="form-group"><label>Texto</label><textarea id="edit-obs-text-${obsId}" rows="2" class="form-group input">${obs.texto}</textarea></div>
                <div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${obsId}" value="${obs.proximaRevision}" class="form-group input"></div>
                <button class="btn btn-success btn-sm" onclick="saveObsEdit('${claimId}', '${obsId}')">Guardar</button>
                <button class="btn btn-sm" onclick="showClaimModal('${claimId}')">Cancelar</button>
            `;
        }

        function saveObsEdit(claimId, obsId) {
            const claim = claimsData.find(c => c.id === claimId);
            const obs = claim.observaciones.find(o => o.id === obsId);
            obs.texto = document.getElementById(`edit-obs-text-${obsId}`).value;
            obs.proximaRevision = document.getElementById(`edit-obs-revision-${obsId}`).value;
            updateClaimNextRevision(claim);
            saveData();
            renderAll();
            showClaimModal(claimId);
        }
        
        function deleteObs(claimId, obsId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta observaci√≥n?')) return;
            const claim = claimsData.find(c => c.id === claimId);
            claim.observaciones = claim.observaciones.filter(o => o.id !== obsId);
            updateClaimNextRevision(claim);
            saveData();
            renderAll();
            showClaimModal(claimId);
        }
        
        function editField(claimId, fieldName, currentValue) {
            editingClaimId = claimId; editingField = fieldName;
            const fieldElement = document.getElementById(`field-${fieldName}`);
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            fieldElement.innerHTML = ''; fieldElement.appendChild(input); input.focus();
            input.addEventListener('blur', saveField);
            input.addEventListener('keypress', e => { if (e.key === 'Enter') saveField(); });
        }
        function saveField() {
            if (!editingClaimId || !editingField) return;
            const claim = claimsData.find(c => c.id === editingClaimId);
            const input = document.getElementById(`field-${editingField}`).querySelector('input');
            if (claim && input) { claim[editingField] = input.value; saveData(); renderAll(); showClaimModal(editingClaimId); }
            editingClaimId = null; editingField = null;
        }
        function deleteClaim(id) { if (confirm('¬øEst√° seguro de que quiere eliminar este siniestro? Esta acci√≥n no se puede deshacer.')) { claimsData = claimsData.filter(c => c.id !== id); saveData(); renderAll(); closeModal('claimInfoModal'); } }
        function addObservation(event, claimId) {
            event.preventDefault();
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            claim.observaciones.push({ id: generateId({}), fecha: getTodayYMD(), texto: document.getElementById('newObsText').value, proximaRevision: document.getElementById('newRevisionDate').value, completed: false });
            updateClaimNextRevision(claim);
            saveData(); renderAll(); showClaimModal(claimId);
        }

        function exportToExcel() {
            const excelData = claimsData.map(c => ({
                'Cliente': c.cliente, 'DNI': c.dni, 'Celular': c.celular, 'Asegurado en': c.aseguradoEn,
                'Cia. Contraria': c.contra, 'N¬∞ Reclamo': c.numeroReclamo, 'Estado': c.estado, 
                'Presupuesto': c.presupuesto, 'Indemnizaci√≥n': c.indemnizacion, 'Honorarios': c.honorarios,
                'Acuerdo': c.acuerdo, 'Fecha Pago': c.fechaPago, 'Factura': c.factura,
                'Pr√≥xima Revisi√≥n': formatDate(c.fechaRevision), '√öltima Tarea': c.observacion,
                'Historial Observaciones': (c.observaciones || []).map(obs => `[Rev: ${formatDate(obs.proximaRevision)}]: ${obs.texto}`).join(' \n ')
            }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Siniestros');
            XLSX.writeFile(workbook, `Siniestros_${getTodayYMD()}.xlsx`);
        }
        function exportData() { const dataStr = JSON.stringify(claimsData, null, 2); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'})); link.download = `datos_planilla_siniestros_${getTodayYMD()}.json`; link.click(); }
        function importData() { document.getElementById('importInput').click(); }
        function handleImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported) && confirm(`¬øImportar ${imported.length} siniestros? Esto sobreescribir√° los datos actuales.`)) { claimsData = imported; saveData(); loadData(); renderAll(); } } catch (err) { alert('Error al importar el archivo. Verifique que sea un JSON v√°lido.'); } };
            reader.readAsText(file); event.target.value = '';
        }

        function printClaimSheet(claimId) {
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            const printContent = `
                <div class="print-area">
                    <h2>Ficha del Siniestro</h2>
                    <h3>${getDisplayName(claim)}</h3>
                    <div class="info-grid">
                        ${Object.entries({cliente: 'Cliente', dni: 'DNI', celular: 'Celular', aseguradoEn: 'Asegurado en', contra: 'Cia. Contraria', numeroReclamo: 'N¬∞ Reclamo', presupuesto: 'Presupuesto', indemnizacion: 'Indemnizaci√≥n', honorarios: 'Honorarios', acuerdo: 'Acuerdo', fechaPago: 'Fecha Pago', factura: 'Factura', estado: 'Estado'}).map(([key, label]) => `
                        <div class="info-item">
                            <div class="info-label">${label}</div>
                            <div class="info-value">${claim[key] || 'S/D'}</div>
                        </div>`).join('')}
                    </div>
                </div>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Ficha del Siniestro</title><style>${document.querySelector("style").innerHTML}</style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function printClaimHistory(claimId) {
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            const historyHTML = renderHistoryListForPrint(claim);
            const printContent = `
                <div class="print-area">
                    <h2>Historial de Observaciones</h2>
                    <h3>${getDisplayName(claim)}</h3>
                    ${historyHTML}
                </div>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Historial del Siniestro</title><style>${document.querySelector("style").innerHTML}</style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function renderHistoryListForPrint(claim) {
            const history = [...(claim.observaciones || [])].sort((a, b) => (b.proximaRevision || '').localeCompare(a.proximaRevision || ''));
            return history.length === 0 ? '<p>No hay observaciones registradas.</p>' : history.map(item => {
                return `<div class="history-item ${item.completed ? 'completed' : ''}">
                    <div class="history-date">Revisar el: ${formatDate(item.proximaRevision)}</div>
                    <div class="history-text">${item.texto}</div>
                </div>`;
            }).join('');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newClaimModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('newClaimModal')">&times;</span><h2>‚ûï Agregar Nuevo Siniestro</h2><form id="newClaimForm"><div class="info-grid" style="grid-template-columns: 1fr 1fr;"><div class="form-group"><label>Cliente *</label><input type="text" id="newCliente" required></div><div class="form-group"><label>DNI</label><input type="text" id="newDni"></div><div class="form-group"><label>Celular</label><input type="text" id="newCelular"></div><div class="form-group"><label>Asegurado en</label><input type="text" id="newAseguradoEn"></div><div class="form-group"><label>Cia. Contraria</label><input type="text" id="newContra"></div><div class="form-group"><label>N¬∞ Reclamo</label><input type="text" id="newNumeroReclamo"></div><div class="form-group"><label>Presupuesto</label><input type="text" id="newPresupuesto"></div><div class="form-group"><label>Indemnizaci√≥n</label><input type="text" id="newIndemnizacion"></div><div class="form-group"><label>Honorarios</label><input type="text" id="newHonorarios"></div><div class="form-group"><label>Acuerdo</label><input type="text" id="newAcuerdo"></div><div class="form-group"><label>Fecha Pago</label><input type="date" id="newFechaPago"></div><div class="form-group"><label>Factura</label><input type="text" id="newFactura"></div><div class="form-group"><label>Estado *</label><select id="newEstado" required><option value="EJECUCION">Ejecuci√≥n</option><option value="FINALIZADA">Finalizada</option><option value="RECHAZADO">Rechazado</option><option value="DEMORADA">Demorada</option></select></div></div><div class="form-group" style="margin-top:20px;"><label>Observaci√≥n Inicial (Opcional)</label><textarea id="newObservacion" rows="3"></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n para Tarea Inicial</label><input type="date" id="newFechaRevision"></div><div style="text-align:center;"><button type="submit" class="btn btn-success">üíæ Guardar Siniestro</button></div></form>`;
            document.getElementById('claimSelectorModal').querySelector('.modal-content').innerHTML = `<span class="close" onclick="closeModal('claimSelectorModal')">&times;</span><h2>üëÅÔ∏è Seleccionar Siniestro</h2><div class="form-group"><select id="claimSelector" onchange="loadClaimInfo()"></select></div>`;
            
            document.getElementById('newClaimForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newClaim = {
                    id: generateId({}),
                    cliente: document.getElementById('newCliente').value.toUpperCase(),
                    dni: document.getElementById('newDni').value,
                    celular: document.getElementById('newCelular').value,
                    aseguradoEn: document.getElementById('newAseguradoEn').value,
                    contra: document.getElementById('newContra').value,
                    numeroReclamo: document.getElementById('newNumeroReclamo').value,
                    presupuesto: document.getElementById('newPresupuesto').value,
                    indemnizacion: document.getElementById('newIndemnizacion').value,
                    honorarios: document.getElementById('newHonorarios').value,
                    acuerdo: document.getElementById('newAcuerdo').value,
                    fechaPago: document.getElementById('newFechaPago').value,
                    factura: document.getElementById('newFactura').value,
                    estado: document.getElementById('newEstado').value,
                    observaciones: []
                };
                const obsText = document.getElementById('newObservacion').value;
                const revDate = document.getElementById('newFechaRevision').value;
                if (obsText && revDate) {
                    newClaim.observaciones.push({
                        id: generateId({}),
                        fecha: getTodayYMD(),
                        texto: obsText,
                        proximaRevision: revDate,
                        completed: false
                    });
                }
                updateClaimNextRevision(newClaim);
                claimsData.push(newClaim);
                saveData();
                renderAll();
                closeModal('newClaimModal');
                e.target.reset();
            });

            loadData();
            renderAll();
        });
        window.addEventListener('click', e => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });
    </script>
</body>
</html>
